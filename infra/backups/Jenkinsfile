pipeline {
    agent any
    
    options {
        timestamps()
        ansiColor('xterm')
        timeout(time: 2, unit: 'HOURS')
        buildDiscarder(logRotator(numToKeepStr: '30'))
    }

    environment {
        RESTIC_REPOSITORY = "s3:http://${MINIO_API_HOST}/${MINIO_BACKUP_BUCKET}"
        BACKUP_HOSTNAME = "workflow-prod-01"
        PUSHGATEWAY_URL = "http://${PUSHGATEWAY_HOST}"
    }

    parameters {
        booleanParam(
            name: 'RUN_RESTORE_TEST', 
            defaultValue: false, 
            description: 'Ex√©cuter un test de restauration apr√®s la sauvegarde'
        )
        choice(
            name: 'BACKUP_TYPE',
            choices: ['daily', 'manual', 'full'],
            description: 'Type de sauvegarde √† effectuer'
        )
        string(
            name: 'RESTORE_PATH',
            defaultValue: '/backup/jenkins/jobs',
            description: 'Chemin √† restaurer pour le test (si activ√©)'
        )
    }

    triggers {
        // Sauvegarde quotidienne √† 2h du matin (heure al√©atoire pour √©viter la surcharge)
        cron('H 2 * * *')
    }

    stages {
        stage('Pre-backup Checks') {
            steps {
                script {
                    echo "üîç V√©rification de l'environnement de sauvegarde..."
                    
                    // V√©rifier que les conteneurs n√©cessaires sont en cours d'ex√©cution
                    sh '''
                        echo "V√©rification des conteneurs..."
                        docker ps --format "table {{.Names}}\\t{{.Status}}" | grep -E "(minio|restic-runner)"
                        
                        echo "V√©rification de l'espace disque..."
                        df -h /var/lib/docker
                        
                        echo "V√©rification de la connectivit√© MinIO..."
                        curl -f http://${MINIO_API_HOST}/minio/health/live || echo "ATTENTION: MinIO non accessible"
                    '''
                }
            }
        }

        stage('Backup Workflow') {
            steps {
                script {
                    echo "üöÄ D√©marrage de la sauvegarde ${params.BACKUP_TYPE}..."
                }
                
                withCredentials([
                    file(credentialsId: 'restic-password-file', variable: 'RESTIC_PASSWORD_FILE'),
                    string(credentialsId: 'minio-access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'minio-secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh '''
                        # Export des variables d'environnement pour le conteneur
                        export BACKUP_START_TIME=$(date +%s)
                        
                        echo "üì¶ Ex√©cution de la sauvegarde dans le conteneur restic-runner..."
                        docker exec \
                            -e RESTIC_REPOSITORY \
                            -e AWS_ACCESS_KEY_ID \
                            -e AWS_SECRET_ACCESS_KEY \
                            -e BACKUP_HOSTNAME \
                            -e PUSHGATEWAY_URL \
                            -e RESTIC_PASSWORD_FILE=/secrets/restic_password \
                            restic-runner sh -c '
                                # Cr√©ation du fichier de mot de passe
                                mkdir -p /secrets
                                echo "'"$RESTIC_PASSWORD"'" > /secrets/restic_password
                                chmod 600 /secrets/restic_password
                                
                                # Ex√©cution du script de sauvegarde
                                /backup-scripts/backup.sh
                            '
                        
                        echo "‚úÖ Sauvegarde termin√©e avec succ√®s"
                    '''
                }
            }
            
            post {
                failure {
                    script {
                        echo "‚ùå √âchec de la sauvegarde"
                        // Envoyer une m√©trique d'√©chec
                        withCredentials([
                            string(credentialsId: 'minio-access-key', variable: 'AWS_ACCESS_KEY_ID'),
                            string(credentialsId: 'minio-secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                        ]) {
                            sh '''
                                docker exec \
                                    -e PUSHGATEWAY_URL \
                                    -e BACKUP_HOSTNAME \
                                    restic-runner sh -c '
                                        if [ -n "${PUSHGATEWAY_URL}" ]; then
                                            echo "restic_backup_success 0" | curl --data-binary @- "${PUSHGATEWAY_URL}/metrics/job/restic_backup/instance/${BACKUP_HOSTNAME}" --max-time 10 --silent || true
                                        fi
                                    '
                            '''
                        }
                    }
                }
            }
        }

        stage('Backup Verification') {
            steps {
                script {
                    echo "üîç V√©rification de la sauvegarde..."
                }
                
                withCredentials([
                    file(credentialsId: 'restic-password-file', variable: 'RESTIC_PASSWORD_FILE'),
                    string(credentialsId: 'minio-access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'minio-secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh '''
                        echo "üìä Affichage des snapshots r√©cents..."
                        docker exec \
                            -e RESTIC_REPOSITORY \
                            -e AWS_ACCESS_KEY_ID \
                            -e AWS_SECRET_ACCESS_KEY \
                            -e RESTIC_PASSWORD_FILE=/secrets/restic_password \
                            restic-runner sh -c '
                                echo "'"$RESTIC_PASSWORD"'" > /secrets/restic_password
                                chmod 600 /secrets/restic_password
                                
                                echo "=== Snapshots r√©cents ==="
                                restic snapshots --compact | tail -10
                                
                                echo "=== Statistiques du repository ==="
                                restic stats --mode raw-data
                            '
                    '''
                }
            }
        }

        stage('Restore Test') {
            when {
                expression { return params.RUN_RESTORE_TEST == true }
            }
            steps {
                script {
                    echo "üîÑ Test de restauration..."
                }
                
                withCredentials([
                    file(credentialsId: 'restic-password-file', variable: 'RESTIC_PASSWORD_FILE'),
                    string(credentialsId: 'minio-access-key', variable: 'AWS_ACCESS_KEY_ID'),
                    string(credentialsId: 'minio-secret-key', variable: 'AWS_SECRET_ACCESS_KEY')
                ]) {
                    sh '''
                        echo "üß™ Test de restauration du chemin: ${RESTORE_PATH}"
                        docker exec \
                            -e RESTIC_REPOSITORY \
                            -e AWS_ACCESS_KEY_ID \
                            -e AWS_SECRET_ACCESS_KEY \
                            -e RESTIC_PASSWORD_FILE=/secrets/restic_password \
                            restic-runner sh -c '
                                echo "'"$RESTIC_PASSWORD"'" > /secrets/restic_password
                                chmod 600 /secrets/restic_password
                                
                                # Nettoyage du r√©pertoire de test
                                rm -rf /restore-test
                                mkdir -p /restore-test
                                
                                # Test de restauration
                                /backup-scripts/restore.sh /restore-test "'"${RESTORE_PATH}"'" latest
                                
                                echo "=== Contenu restaur√© ==="
                                find /restore-test -type f | head -10
                                echo "Total fichiers restaur√©s: $(find /restore-test -type f | wc -l)"
                                
                                # Nettoyage
                                rm -rf /restore-test
                            '
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                echo "üßπ Nettoyage post-sauvegarde..."
                // Nettoyage des fichiers temporaires si n√©cessaire
            }
        }
        
        success {
            script {
                echo "‚úÖ Pipeline de sauvegarde termin√© avec succ√®s"
                // Notification de succ√®s (Slack, email, etc.)
            }
        }
        
        failure {
            script {
                echo "‚ùå √âchec du pipeline de sauvegarde"
                // Notification d'√©chec (Slack, email, etc.)
            }
        }
        
        cleanup {
            script {
                // Nettoyage final
                sh '''
                    # Nettoyage des secrets temporaires dans le conteneur
                    docker exec restic-runner sh -c 'rm -rf /secrets /restore-test' || true
                '''
            }
        }
    }
}
